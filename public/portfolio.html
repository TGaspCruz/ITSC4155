<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <header>
        <h1 id="username">Portfolio</h1>
        <nav>
        <a  class="navLink" href="dashboard.html">Dashboard</a>
        <a class="navLink" href="portfolio.html">Portfolio</a>
        <a class="navLink" href="advanceSearch.html">Advance Search</a>
        </nav>
        <button id="logoutBtn">Logout</button>
    </header>
    <main class="portfolio-main">
        <section>
            <h2>Available Funds</h2>
            <p id="available-funds"></p>
        </section>
        <section>
            <h2>Stock Holdings</h2>
            <div id="table-container">
            <table id="holdings-table" border="1" cellpadding="6">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Quantity</th>
                        <th>Avg Price</th>
                        <th>Market Value</th>
                    </tr>
                </thead>
                <tbody id="holdings-body">
                </tbody>
            </table>
            </div>
        </section>
    </main>
    <script src="portfolio.js"></script>
</body>

<script>

    
    
    
    async function getFunds() {
  
  
  
  const res = await fetch("/api/getFunds");
  const data = await res.json();
  if (data.success) {
    document.getElementById("available-funds").textContent = data.availableFunds;
    
  } else {
    console.error("Failed to fetch funds:", data.message);
  }
}

async function getStocks() {
  const res = await fetch("/api/getStocks");
  const data = await res.json();
  if (data.success) {
    const tbody = document.getElementById("holdings-body");
    tbody.innerHTML = ""; 

    data.stocks.forEach(stock => {
      const marketValue = (stock.quantity * stock.avgPrice).toFixed(2);
      const row = document.createElement("tr");
      
      row.innerHTML = `
        <td>${stock.ticker}</td>
        <td>${stock.quantity}</td>
        <td>${stock.avgPrice.toFixed(2)}</td>
        <td>${marketValue}</td>
        <td id = "${stock._id}"> <button id= "sellStockButton${stock._id}">Sell</button> </td>
      `;

      tbody.appendChild(row);



      
    });

     data.stocks.forEach(stock => { 
      document.getElementById("sellStockButton" + stock._id).addEventListener("click", () => {


      let clickedStock = document.getElementById("sellStockButton" + stock._id).parentElement.id;
      console.log(clickedStock + stock._id);
    
      data.stocks.forEach(stock => {
        let sellname = document.getElementById([stock._id]);
      
        if(clickedStock === stock._id){
        console.log(sellname);
        alert("Sold " + stock._id );

        document.getElementById(stock._id).parentElement.style.display = "none";
        

        fetch("/api/sellStock", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    ticker: stock._id,
    price: stock.avgPrice.toFixed(2),
    quantity: stock.quantity
  })
})
  .then(response => response.json())
  .then(data => {
    console.log(data);
    
  });

  

        
        
        }
        
      
      
      
      }
      
        
      );
      
    });


     });
    
    
  } else {
    console.error("Failed to fetch stocks:", data.message);
  }
}




window.addEventListener("load", () => {
  getFunds();
  getStocks();
});



</script>
</html>